-- ê¹¨ë—í•œ ì¬ì‹¤í–‰ì„ ìœ„í•´(ì˜µì…˜)
DROP TABLE IF EXISTS member_tickets CASCADE;
DROP TABLE IF EXISTS point_transactions CASCADE;
DROP TABLE IF EXISTS ticket_types CASCADE;
DROP TABLE IF EXISTS rentals CASCADE;
DROP TABLE IF EXISTS reports CASCADE;
DROP TABLE IF EXISTS post_attachments CASCADE;
DROP TABLE IF EXISTS post_likes CASCADE;
DROP TABLE IF EXISTS station_favorites CASCADE;
DROP TABLE IF EXISTS comments CASCADE;
DROP TABLE IF EXISTS post_images CASCADE;
DROP TABLE IF EXISTS posts CASCADE;
-- ì¶”ê°€: ì—…ì  ë° ë­í‚¹ í…Œì´ë¸” (members ì˜ì¡´)
DROP TABLE IF EXISTS weekly_rankings CASCADE;
DROP TABLE IF EXISTS member_achievements CASCADE;
DROP TABLE IF EXISTS achievements CASCADE;
DROP TABLE IF EXISTS members CASCADE;
DROP TABLE IF EXISTS bikes CASCADE;
DROP TABLE IF EXISTS stations CASCADE;

-- ëŒ€ì—¬ì†Œ
CREATE TABLE stations (
  station_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  bike_count INT DEFAULT 0,
  status VARCHAR(20) NOT NULL DEFAULT 'ì •ìƒ',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (name),
  CHECK (status IN ('ì •ìƒ','ì ê²€ì¤‘','íì‡„'))
);
-- ìì „ê±°
CREATE TABLE bikes (
  bike_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  station_id INT,
  status VARCHAR(20) NOT NULL DEFAULT 'ì •ìƒ',         -- ì •ìƒ/ê³ ì¥/ìˆ˜ë¦¬ì¤‘
  lock_status VARCHAR(20) NOT NULL DEFAULT 'LOCKED',   -- LOCKED/IN_USE
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (station_id) REFERENCES stations(station_id)
    ON UPDATE CASCADE ON DELETE SET NULL,
  CHECK (status IN ('ì •ìƒ','ê³ ì¥','ìˆ˜ë¦¬ì¤‘')),
  CHECK (lock_status IN ('LOCKED','IN_USE'))
);

-- íšŒì›
CREATE TABLE members (
  member_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(100) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  role VARCHAR(20) DEFAULT 'user',
  point_balance INT NOT NULL DEFAULT 0,
  has_subscription BOOLEAN DEFAULT FALSE,
  current_latitude DOUBLE PRECISION,
  current_longitude DOUBLE PRECISION,
  last_bike_id INT,
  kakao_id BIGINT UNIQUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (last_bike_id) REFERENCES bikes(bike_id)
    ON UPDATE CASCADE ON DELETE SET NULL
);

-- Station favorites
CREATE TABLE station_favorites (
  favorite_id   INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id     INT NOT NULL,
  station_id    INT NOT NULL,
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_station_favorites_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_station_favorites_station
    FOREIGN KEY (station_id) REFERENCES stations(station_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT unique_station_favorite UNIQUE (member_id, station_id)
);

-- ëŒ€ì—¬ ê¸°ë¡
CREATE TABLE rentals (
  rental_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id INT,
  bike_id INT,
  start_station_id INT,
  end_station_id INT,
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  distance_km DOUBLE PRECISION,
  FOREIGN KEY (member_id) REFERENCES members(member_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (bike_id) REFERENCES bikes(bike_id)
    ON UPDATE CASCADE ON DELETE SET NULL,
  FOREIGN KEY (start_station_id) REFERENCES stations(station_id)
    ON UPDATE CASCADE ON DELETE SET NULL,
  FOREIGN KEY (end_station_id) REFERENCES stations(station_id)
    ON UPDATE CASCADE ON DELETE SET NULL
);

-- ì—…ì  ì¢…ë¥˜ í…Œì´ë¸”
CREATE TABLE achievements (
  achievement_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon VARCHAR(50),
  condition_type VARCHAR(50) NOT NULL, -- 'FIRST_RIDE', 'CONSECUTIVE_DAYS', 'TOTAL_DISTANCE', 'TOTAL_STATIONS', 'TOTAL_RIDES'
  condition_value INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- íšŒì›ë³„ ë‹¬ì„±í•œ ì—…ì 
CREATE TABLE member_achievements (
  member_achievement_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id INT NOT NULL,
  achievement_id INT NOT NULL,
  earned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  points_awarded BOOLEAN DEFAULT FALSE,
  CONSTRAINT fk_member_achievement_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_member_achievement_achievement
    FOREIGN KEY (achievement_id) REFERENCES achievements(achievement_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT unique_member_achievement UNIQUE (member_id, achievement_id)
);

-- ì£¼ë³„ ë­í‚¹ ê¸°ë¡ í…Œì´ë¸”
CREATE TABLE weekly_rankings (
  ranking_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  week_start_date DATE NOT NULL, -- ì£¼ì˜ ì‹œì‘ì¼ (ì›”ìš”ì¼)
  member_id INT NOT NULL,
  total_distance_km DOUBLE PRECISION NOT NULL DEFAULT 0,
  rank_position INT,
  points_awarded BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_weekly_ranking_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT unique_weekly_member UNIQUE (week_start_date, member_id)
);

-- 5) REPORT (member:bike = M:Nì„ ì‹ ê³ ë¡œ ë¶„í•´)
CREATE TABLE reports (
  report_id      INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id      INT NOT NULL,
  bike_id        INT NOT NULL,
  title          VARCHAR(100) NOT NULL,
  report_content TEXT,
  status         VARCHAR(20) NOT NULL DEFAULT 'pending',  -- pending/resolved/rejected
  report_time    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_report_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_report_bike
    FOREIGN KEY (bike_id) REFERENCES bikes(bike_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CHECK (status IN ('pending','resolved','rejected'))
);

-- í¬ì¸íŠ¸ íŠ¸ëœì­ì…˜
CREATE TABLE point_transactions (
  transaction_id  INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id       INT NOT NULL,
  amount          INT NOT NULL,
  type            VARCHAR(20) NOT NULL,
  description     TEXT,
  balance_after   INT NOT NULL,
  created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_point_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CHECK (type IN ('CHARGE','USE','ADJUST'))
);

CREATE INDEX idx_point_transactions_member ON point_transactions(member_id, created_at DESC);

-- 6) POST (ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œë¬¼)
CREATE TABLE posts (
  post_id       INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id     INT NOT NULL,
  title         VARCHAR(150) NOT NULL,
  content       TEXT,
  category      VARCHAR(30),
  views         INT DEFAULT 0,              -- ì¡°íšŒìˆ˜
  likes         INT DEFAULT 0,              -- ì¢‹ì•„ìš” ìˆ˜
  comments_count INT DEFAULT 0,            -- ëŒ“ê¸€ ìˆ˜
  is_pinned     BOOLEAN DEFAULT FALSE,       -- ê³ ì • ì—¬ë¶€ (ê´€ë¦¬ìë§Œ ì„¤ì • ê°€ëŠ¥)
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_post_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
      ON UPDATE CASCADE ON DELETE CASCADE
);

-- ê²Œì‹œê¸€ ì´ë¯¸ì§€
CREATE TABLE post_images (
  image_id   INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id    INT NOT NULL,
  image_url  TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_post_images_post
    FOREIGN KEY (post_id) REFERENCES posts(post_id)
      ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE INDEX idx_post_images_post ON post_images(post_id);

-- 7) TICKET_TYPES (ì´ìš©ê¶Œ ì¢…ë¥˜)
CREATE TABLE ticket_types (
  ticket_type_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name           VARCHAR(50) NOT NULL UNIQUE,  -- '1ì‹œê°„ê¶Œ', '1ì¼ê¶Œ', 'ì •ê¸°ê¶Œ', 'ì—°ê°„ê¶Œ'
  duration_hours INT NOT NULL,                 -- ìœ íš¨ ê¸°ê°„ (ì‹œê°„ ë‹¨ìœ„)
  price          INT NOT NULL,                 -- ê°€ê²© (ì›)
  description    TEXT,                          -- ì„¤ëª…
  ride_limit_minutes INT,                       -- 1íšŒ ì´ìš© ì œí•œ ì‹œê°„ (ë¶„)
  created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CHECK (duration_hours > 0),
  CHECK (price >= 0)
);

-- 8) MEMBER_TICKETS (íšŒì›ì´ êµ¬ë§¤í•œ ì´ìš©ê¶Œ)
CREATE TABLE member_tickets (
  member_ticket_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id        INT NOT NULL,
  ticket_type_id   INT NOT NULL,
  purchase_time    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expiry_time      TIMESTAMP NOT NULL,          -- ë§Œë£Œ ì‹œê°„
  status           VARCHAR(20) NOT NULL DEFAULT 'active',  -- active/used/expired
  CONSTRAINT fk_member_ticket_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_member_ticket_type
    FOREIGN KEY (ticket_type_id) REFERENCES ticket_types(ticket_type_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CHECK (status IN ('active','used','expired'))
);

-- ê¸°ë³¸ ì´ìš©ê¶Œ ì¢…ë¥˜ ë°ì´í„° ì‚½ì…
INSERT INTO ticket_types (name, duration_hours, price, description, ride_limit_minutes) VALUES
('1ì‹œê°„ê¶Œ', 1, 1000, '1ì‹œê°„ ë™ì•ˆ ì´ìš© ê°€ëŠ¥,ì¶”ê°€ ì‹œê°„ë‹¹ 1000ì›', 60),
('1ì¼ê¶Œ', 24, 2000, '24ì‹œê°„ ë¬´ì œí•œ ì´ìš©,1íšŒ ì´ìš©ì‹œê°„ 2ì‹œê°„ê¹Œì§€', 120),
('ì •ê¸°ê¶Œ', 720, 5000, '30ì¼ê°„ ë¬´ì œí•œ ì´ìš©,1íšŒ ì´ìš©ì‹œê°„ 2ì‹œê°„ê¹Œì§€', 120),
('ì—°ê°„ê¶Œ', 8760, 30000, '1ë…„ê°„ ë¬´ì œí•œ ì´ìš©,1íšŒ ì´ìš©ì‹œê°„ 2ì‹œê°„ê¹Œì§€', 120);

-- ì—…ì  ì´ˆê¸° ë°ì´í„° ì‚½ì…
INSERT INTO achievements (name, description, icon, condition_type, condition_value) VALUES
('ì²« ê±¸ìŒ', 'ì²« ë”°ë¦‰ì´ ì´ìš© ì™„ë£Œ', 'ğŸš´', 'FIRST_RIDE', 1),
('ì´ˆë³´ ë¼ì´ë”', '10íšŒ ì´ìš© ë‹¬ì„±', 'ğŸš²', 'TOTAL_RIDES', 10),
('ì¤‘ê¸‰ ë¼ì´ë”', '50íšŒ ì´ìš© ë‹¬ì„±', 'ğŸš´', 'TOTAL_RIDES', 50),
('ì¶œí‡´ê·¼ ë§ˆìŠ¤í„°', '10ì¼ ì—°ì† ì´ìš©', 'ğŸ†', 'CONSECUTIVE_DAYS', 10),
('ì¥ê±°ë¦¬ ë¼ì´ë”', 'ëˆ„ì  100km ë‹¬ì„±', 'ğŸ¯', 'TOTAL_DISTANCE', 100),
('í™˜ê²½ ì§€í‚´ì´', 'ëˆ„ì  500km ë‹¬ì„±', 'ğŸŒ¿', 'TOTAL_DISTANCE', 500),
('ì „êµ­êµ¬', '50ê°œ ì´ìƒì˜ ëŒ€ì—¬ì†Œ ì´ìš©', 'ğŸ—ºï¸', 'TOTAL_STATIONS', 50),
('ë‹¨ê³¨ íšŒì›', '100íšŒ ì´ìš© ë‹¬ì„±', 'â­', 'TOTAL_RIDES', 100);

-- 9) COMMENTS (ëŒ“ê¸€)
CREATE TABLE comments (
  comment_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id    INT NOT NULL,
  member_id  INT NOT NULL,
  content    TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_comment_post
    FOREIGN KEY (post_id) REFERENCES posts(post_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_comment_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
      ON UPDATE CASCADE ON DELETE CASCADE
);

-- 10) POST_LIKES (ê²Œì‹œê¸€ ì¢‹ì•„ìš”)
CREATE TABLE post_likes (
  like_id    INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id    INT NOT NULL,
  member_id  INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_like_post
    FOREIGN KEY (post_id) REFERENCES posts(post_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_like_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
      ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT unique_post_like UNIQUE (post_id, member_id)
);

-- ì¡°íšŒ ì„±ëŠ¥ ì¸ë±ìŠ¤(í—ˆìš© ëª©ë¡: CREATE INDEX)
CREATE INDEX idx_bikes_station ON bikes(station_id);
CREATE INDEX idx_rentals_member_active ON rentals(member_id, end_time);
CREATE INDEX idx_stations_status_bikes ON stations(status, bike_count);
CREATE INDEX idx_member_tickets_member ON member_tickets(member_id);
CREATE INDEX idx_member_tickets_status ON member_tickets(status, expiry_time);
CREATE INDEX idx_comments_post ON comments(post_id);
CREATE INDEX idx_post_likes_post ON post_likes(post_id);
CREATE INDEX idx_post_likes_member ON post_likes(member_id);
CREATE INDEX idx_station_favorites_member ON station_favorites(member_id);
CREATE INDEX idx_station_favorites_station ON station_favorites(station_id);
CREATE INDEX idx_members_kakao_id ON members(kakao_id);
-- ì—…ì  ë° ë­í‚¹ ì¸ë±ìŠ¤
CREATE INDEX idx_weekly_rankings_week ON weekly_rankings(week_start_date, total_distance_km DESC);
CREATE INDEX idx_member_achievements_member ON member_achievements(member_id);
CREATE INDEX idx_rentals_distance ON rentals(distance_km);


-- ê²Œì‹œê¸€ ì²¨ë¶€íŒŒì¼ í…Œì´ë¸” ì¶”ê°€
CREATE TABLE IF NOT EXISTS post_attachments (
  attachment_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id       INT NOT NULL,
  file_name     VARCHAR(255) NOT NULL,     -- ì›ë³¸ íŒŒì¼ëª…
  file_path     TEXT NOT NULL,             -- ì„œë²„ ì €ì¥ ê²½ë¡œ
  file_size     BIGINT NOT NULL,           -- íŒŒì¼ í¬ê¸° (bytes)
  file_type     VARCHAR(100),              -- MIME íƒ€ì…
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_post_attachments_post
    FOREIGN KEY (post_id) REFERENCES posts(post_id)
      ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_post_attachments_post ON post_attachments(post_id);

-- ê¸°ì¡´ post_images í…Œì´ë¸”ì— file_sizeì™€ file_name ì¶”ê°€ (ì„ íƒì‚¬í•­)
ALTER TABLE post_images ADD COLUMN IF NOT EXISTS file_name VARCHAR(255);
ALTER TABLE post_images ADD COLUMN IF NOT EXISTS file_size BIGINT;

-- í…ŒìŠ¤íŠ¸ìš© íšŒì› ë°ì´í„° (ì•”í˜¸ëŠ” $2b$10$N9qo8uLOickgx2ZMRZoMyeë¡œ "password" hashed)
INSERT INTO members (username, email, password, role, point_balance, has_subscription) VALUES
('admin_user', 'admin@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'admin', 10000, true),
('user_kim', 'kim@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 5000, false),
('user_lee', 'lee@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 3500, true),
('user_park', 'park@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 2000, false),
('user_choi', 'choi@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 4500, true),
('user_jung', 'jung@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 1800, false),
('user_kang', 'kang@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 6000, true),
('user_jo', 'jo@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 3200, false),
('user_oh', 'oh@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 2800, true),
('user_seo', 'seo@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 5200, false),
('user_han', 'han@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 4100, true),
('user_moon', 'moon@example.com', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7Eb2fQ7XkuNEH5GhvB8S8Baa', 'user', 3600, false) ON CONFLICT DO NOTHING;
