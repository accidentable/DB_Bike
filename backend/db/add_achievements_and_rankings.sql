-- ì—…ì  ì¢…ë¥˜ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS achievements (
  achievement_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon VARCHAR(50),
  condition_type VARCHAR(50) NOT NULL, -- 'FIRST_RIDE', 'CONSECUTIVE_DAYS', 'TOTAL_DISTANCE', 'TOTAL_STATIONS', 'TOTAL_RIDES'
  condition_value INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- íšŒì›ë³„ ë‹¬ì„±í•œ ì—…ì 
CREATE TABLE IF NOT EXISTS member_achievements (
  member_achievement_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id INT NOT NULL,
  achievement_id INT NOT NULL,
  earned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  points_awarded BOOLEAN DEFAULT FALSE,
  CONSTRAINT fk_member_achievement_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_member_achievement_achievement
    FOREIGN KEY (achievement_id) REFERENCES achievements(achievement_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT unique_member_achievement UNIQUE (member_id, achievement_id)
);

-- rentals í…Œì´ë¸”ì— ê±°ë¦¬ ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE rentals ADD COLUMN IF NOT EXISTS distance_km DOUBLE PRECISION;

-- ì£¼ë³„ ë­í‚¹ ê¸°ë¡ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS weekly_rankings (
  ranking_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  week_start_date DATE NOT NULL, -- ì£¼ì˜ ì‹œì‘ì¼ (ì›”ìš”ì¼)
  member_id INT NOT NULL,
  total_distance_km DOUBLE PRECISION NOT NULL DEFAULT 0,
  rank_position INT,
  points_awarded BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_weekly_ranking_member
    FOREIGN KEY (member_id) REFERENCES members(member_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT unique_weekly_member UNIQUE (week_start_date, member_id)
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX IF NOT EXISTS idx_weekly_rankings_week ON weekly_rankings(week_start_date, total_distance_km DESC);
CREATE INDEX IF NOT EXISTS idx_member_achievements_member ON member_achievements(member_id);
CREATE INDEX IF NOT EXISTS idx_rentals_distance ON rentals(distance_km);

-- ì—…ì  ì´ˆê¸° ë°ì´í„° ì‚½ì…
INSERT INTO achievements (name, description, icon, condition_type, condition_value) VALUES
('ì²« ê±¸ìŒ', 'ì²« ë”°ë¦‰ì´ ì´ìš© ì™„ë£Œ', 'ğŸš´', 'FIRST_RIDE', 1),
('ì´ˆë³´ ë¼ì´ë”', '10íšŒ ì´ìš© ë‹¬ì„±', 'ğŸš²', 'TOTAL_RIDES', 10),
('ì¤‘ê¸‰ ë¼ì´ë”', '50íšŒ ì´ìš© ë‹¬ì„±', 'ğŸš´', 'TOTAL_RIDES', 50),
('ì¶œí‡´ê·¼ ë§ˆìŠ¤í„°', '10ì¼ ì—°ì† ì´ìš©', 'ğŸ†', 'CONSECUTIVE_DAYS', 10),
('ì¥ê±°ë¦¬ ë¼ì´ë”', 'ëˆ„ì  100km ë‹¬ì„±', 'ğŸ¯', 'TOTAL_DISTANCE', 100),
('í™˜ê²½ ì§€í‚´ì´', 'ëˆ„ì  500km ë‹¬ì„±', 'ğŸŒ¿', 'TOTAL_DISTANCE', 500),
('ì „êµ­êµ¬', '50ê°œ ì´ìƒì˜ ëŒ€ì—¬ì†Œ ì´ìš©', 'ğŸ—ºï¸', 'TOTAL_STATIONS', 50),
('ë‹¨ê³¨ íšŒì›', '100íšŒ ì´ìš© ë‹¬ì„±', 'â­', 'TOTAL_RIDES', 100)
ON CONFLICT DO NOTHING;